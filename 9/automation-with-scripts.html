<section data-intro class="bg-slate-900/20">
  <h2>مقدمه</h2>
  <p>
    در طول این فصل، ما تمام ابزارهای لازم برای اسکریپت‌نویسی را فرا گرفتیم:
    متغیرها برای ذخیره‌سازی داده، شرط‌ها (if) برای تصمیم‌گیری، حلقه‌ها (for و
    while) برای تکرار و توابع برای سازماندهی کد. اکنون می‌توانیم اسکریپت‌های
    پیچیده و مفیدی بنویسیم. اما هدف نهایی از اسکریپت‌نویسی، رسیدن به
    <b>اتوماسیون</b> است؛ یعنی کاری کنیم که کامپیوتر وظایف را بدون دخالت ما و به
    صورت خودکار انجام دهد.
  </p>
  <p>
    یک اسکریپت، هر چقدر هم که هوشمند باشد، تا زمانی که ما آن را به صورت دستی
    اجرا نکنیم، کاری انجام نمی‌دهد. اما اگر بخواهیم یک اسکریپت به صورت خودکار هر
    شب ساعت ۲ بامداد اجرا شود تا از فایل‌های مهم ما پشتیبان بگیرد چه؟ اینجاست که
    آخرین قطعه از پازل اتوماسیون وارد می‌شود: <b>زمان‌بند Cron</b>. در این درس،
    تمام آموخته‌های خود را در قالب یک اسکریپت کاربردی جمع‌بندی کرده و سپس یاد
    می‌گیریم چگونه اجرای آن را با cron زمان‌بندی کنیم.
  </p>
</section>
<section>
  <h2>یک مثال عملی: اسکریپت پشتیبان‌گیری خودکار</h2>
  <p>
    بیایید یک اسکریپت بنویسیم که از یک دایرکتوری مشخص یک نسخه‌ی پشتیبان فشرده
    تهیه کرده و نتیجه‌ی عملیات (موفقیت یا شکست) را در یک فایل گزارش ثبت کند. این
    اسکریپت تقریباً از تمام مفاهیمی که یاد گرفته‌ایم استفاده می‌کند.
  </p>

  <pre dir="ltr" data-cm-lang="bash">
#!/bin/bash

SOURCE_DIR="/home/me/Documents"
BACKUP_DIR="/home/me/backups"
LOG_FILE="$BACKUP_DIR/backup.log"

log_message() {
  local message="$1"
  echo "$(date +'%Y-%m-%d %H:%M:%S') - $message" >> "$LOG_FILE"
}

mkdir -p "$BACKUP_DIR"

log_message "starting backup process..."

FILENAME="docs-backup-$(date +%Y-%m-%d).tar.gz"
BACKUP_PATH="$BACKUP_DIR/$FILENAME"

tar -czf "$BACKUP_PATH" "$SOURCE_DIR"

if [[ $? -eq 0 ]]; then
  log_message "backup completed successfully: $FILENAME"
else
  log_message "error: backup process failed."
fi
</pre
  >

  <p>
    این اسکریپت با استفاده از متغیرها، توابع، جایگزینی دستور، شرط‌ها و تغییر
    مسیر، یک ابزار پشتیبان‌گیری ساده و قابل اعتماد را ایجاد می‌کند.
  </p>
</section>
<section>
  <h2>زمان‌بندی اسکریپت‌ها با Cron</h2>
  <p>
    <i>Cron</i> یک سرویس (daemon) استاندارد در سیستم‌های لینوکسی است که در
    پس‌زمینه اجرا می‌شود و کار آن اجرای دستورات زمان‌بندی شده است.
    <i>Cron</i> هر دقیقه از خواب بیدار شده و فایلی به نام <b>crontab</b> (مخفف
    <b>cron table</b>) را بررسی می‌کند تا ببیند آیا دستوری برای اجرا در آن دقیقه
    وجود دارد یا خیر. هر کاربر می‌تواند crontab مخصوص به خود را داشته باشد.
  </p>

  <h3>ویرایش Crontab</h3>
  <p>
    برای ویرایش جدول زمان‌بندی خود، از دستور <code>crontab -e</code> استفاده
    کنید. اولین باری که این دستور را اجرا می‌کنید، ممکن است از شما بخواهد که یک
    ویرایشگر متن پیش‌فرض (مانند Nano) را انتخاب کنید.
  </p>

  <pre dir="ltr" data-cm-lang="bash">$ crontab -e</pre>

  <h3>ساختار دستورات Crontab</h3>
  <p>
    هر خط در فایل crontab یک وظیفه‌ی زمان‌بندی شده را مشخص می‌کند و از شش بخش
    تشکیل شده است:
  </p>

  <pre dir="ltr">
# ┌───────────── دقیقه (0 - 59)
# │ ┌───────────── ساعت (0 - 23)
# │ │ ┌───────────── روز ماه (1 - 31)
# │ │ │ ┌───────────── ماه (1 - 12)
# │ │ │ │ ┌───────────── روز هفته (0 - 6) (یکشنبه=0)
# │ │ │ │ │
# * * * * * /مسیر/کامل/دستور/برای/اجرا
</pre
  >

  <p>
    کاراکتر ستاره (<code>*</code>) به معنای «هر مقدار ممکن» است. برای مثال،
    <code>* * * * *</code> به معنای «هر دقیقه از هر ساعت از هر روز و...»
    می‌باشد.
  </p>

  <h3>زمان‌بندی اسکریپت پشتیبان‌گیری</h3>
  <p>
    حالا بیایید اسکریپت پشتیبان‌گیری خود را طوری زمان‌بندی کنیم که هر شب ساعت
    ۲:۳۰ بامداد اجرا شود. خط زیر را به فایل crontab خود اضافه می‌کنیم:
  </p>

  <pre dir="ltr" data-cm-lang="bash">30 2 * * * /home/me/scripts/backup.sh</pre>

  <div data-callout="info">
    <h3>همیشه از مسیر کامل استفاده کنید!</h3>
    <p>
      یک نکته‌ی بسیار حیاتی هنگام کار با <i>cron</i> این است که باید همیشه
      <b>مسیر کامل (absolute path)</b> را به اسکریپت یا دستور خود بدهید.
      <i>Cron</i> در یک محیط بسیار محدود و متفاوت از شل تعاملی شما اجرا می‌شود و
      متغیر <code>$PATH</code> آن ممکن است شامل مسیر اسکریپت‌های شخصی شما نباشد.
    </p>
  </div>
</section>
<section>
  <h2>مدیریت Crontab</h2>
  <p>دو دستور مفید دیگر برای کار با crontab وجود دارد:</p>
  <ul>
    <li>
      <b><code>crontab -l</code>:</b> لیست تمام وظایف زمان‌بندی شده‌ی شما را
      نمایش می‌دهد (<b>l</b>ist).
    </li>
    <li>
      <b><code>crontab -r</code>:</b> کل crontab شما را حذف می‌کند
      (<b>r</b>emove). در استفاده از این دستور بسیار مراقب باشید!
    </li>
  </ul>

  <p>
    برای مشاهده وضعیت سرویس cron و اطمینان از فعال بودن آن، می‌توانید از دستور
    زیر استفاده کنید:
  </p>

  <pre dir="ltr" data-cm-lang="bash">$ systemctl status cron</pre>

  <p>اگر سرویس فعال نبود، با دستور زیر آن را راه‌اندازی کنید:</p>
  <pre dir="ltr" data-cm-lang="bash">$ sudo systemctl start cron</pre>

  <p>همچنین برای فعال شدن خودکار سرویس در هنگام بوت:</p>
  <pre dir="ltr" data-cm-lang="bash">$ sudo systemctl enable cron</pre>
</section>
